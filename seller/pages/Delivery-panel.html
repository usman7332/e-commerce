<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shipping & Delivery Panel</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    .main-content {
      padding: 20px;
      margin-top: 20px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .main-content h1 {
      color: #232f3e;
      margin-bottom: 20px;
      font-size: 24px;
    }

    h2 {
      color: #232f3e;
      margin-bottom: 15px;
      font-size: 20px;
    }

    h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 16px;
    }

    /* Tabs Section */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tab-btn {
      padding: 10px 20px;
      border: 2px solid transparent;
      background-color: #f3f4f6;
      color: #333;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .tab-btn:hover {
      background-color: #e5e7eb;
    }

    .tab-btn.active {
      background-color: #232f3e;
      color: white;
      border-color: #232f3e;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Shipping Partners Grid */
    .partners-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .partner-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .partner-card:hover {
      border-color: #232f3e;
      box-shadow: 0 4px 12px rgba(35, 47, 62, 0.15);
    }

    .partner-card.selected {
      border-color: #232f3e;
      background-color: #f9fafb;
      box-shadow: 0 4px 12px rgba(35, 47, 62, 0.2);
    }

    .partner-logo {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .partner-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .partner-details {
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
    }

    .partner-charge {
      font-size: 14px;
      font-weight: 600;
      color: #232f3e;
    }

    /* Shipments Table */
    .shipments-section {
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #232f3e;
    }

    .search-filter {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .search-bar {
      position: relative;
      flex: 1;
      min-width: 200px;
    }

    .search-bar input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
    }

    .search-bar input:focus {
      outline: none;
      border-color: #232f3e;
      box-shadow: 0 0 0 3px rgba(35, 47, 62, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      font-size: 18px;
      pointer-events: none;
    }

    .filter-select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      background-color: white;
      cursor: pointer;
      min-width: 140px;
    }

    .filter-select:focus {
      outline: none;
      border-color: #232f3e;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    .data-table thead tr {
      border-bottom: 2px solid #ddd;
      background-color: #f5f5f5;
    }

    .data-table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #232f3e;
      font-size: 13px;
      text-transform: uppercase;
    }

    .data-table tbody tr {
      border-bottom: 1px solid #ddd;
      transition: background-color 0.2s;
    }

    .data-table tbody tr:hover {
      background-color: #f5f5f5;
    }

    .data-table td {
      padding: 15px;
      font-size: 13px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-shipped {
      background-color: #d1ecf1;
      color: #0c5460;
    }

    .status-transit {
      background-color: #cfe2ff;
      color: #084298;
    }

    .status-delivery {
      background-color: #fff3cd;
      color: #997404;
    }

    .status-delivered {
      background-color: #d4edda;
      color: #155724;
    }

    .status-failed {
      background-color: #f8d7da;
      color: #721c24;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background-color: #232f3e;
      color: white;
    }

    .btn-primary:hover {
      background-color: #37475a;
    }

    .btn-secondary {
      background-color: #f3f4f6;
      color: #333;
      border: 1px solid #ddd;
    }

    .btn-secondary:hover {
      background-color: #e5e7eb;
    }

    .btn-view {
      background: none;
      border: none;
      color: #0066c0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      padding: 5px 10px;
      transition: color 0.2s;
    }

    .btn-view:hover {
      color: #232f3e;
      text-decoration: underline;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background-color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .pagination button:hover {
      background-color: #f5f5f5;
      border-color: #232f3e;
    }

    .pagination button.active {
      background-color: #232f3e;
      color: white;
      border-color: #232f3e;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 10px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
      padding: 20px;
      background-color: #232f3e;
      color: white;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: white;
    }

    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    .modal-body {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #232f3e;
      box-shadow: 0 0 0 3px rgba(35, 47, 62, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 30px;
      justify-content: flex-end;
    }

    /* Timeline */
    .timeline {
      padding: 20px;
      background-color: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }

    .timeline-item {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      position: relative;
    }

    .timeline-item:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 11px;
      top: 30px;
      width: 2px;
      height: 40px;
      background-color: #ddd;
    }

    .timeline-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: #e5e7eb;
      border: 3px solid white;
      box-shadow: 0 0 0 2px #ddd;
      flex-shrink: 0;
    }

    .timeline-item.active .timeline-dot {
      background-color: #232f3e;
      box-shadow: 0 0 0 2px #ddd;
    }

    .timeline-dot.completed {
      background-color: #10b981;
      box-shadow: 0 0 0 2px #ddd;
    }

    .timeline-content {
      padding-top: 2px;
      flex: 1;
    }

    .timeline-content h4 {
      margin: 0;
      color: #333;
      font-size: 14px;
    }

    .timeline-content p {
      margin: 5px 0 0 0;
      font-size: 12px;
      color: #999;
    }

    /* Responsive */
    @media (max-width: 1080px) {
      .partners-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 15px;
      }

      .section-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .search-filter {
        flex-direction: column;
        width: 100%;
      }

      .search-bar {
        width: 100%;
      }

      .filter-select {
        width: 100%;
      }

      .data-table {
        font-size: 12px;
      }

      .data-table th,
      .data-table td {
        padding: 10px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .partners-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }

      .modal-body {
        padding: 15px;
      }

      .modal-actions {
        flex-direction: column;
      }

      .modal-actions .btn {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .partners-grid {
        grid-template-columns: 1fr;
      }

      .tabs {
        flex-direction: column;
      }

      .tab-btn {
        width: 100%;
      }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      background: white;
      border-radius: 10px;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border: 1px solid #c3e6cb;
    }

    .info-card {
      background: #f9fafb;
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid #0066c0;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- Main Content -->
  <div class="main-content">
    <div class="page active" id="deliveryPage">
      <h1>Shipping & Delivery Panel</h1>

      <!-- TABS -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('partners', this)">Shipping Partners</button>
        <button class="tab-btn" onclick="switchTab('shipments', this)">Create Shipment</button>
        <button class="tab-btn" onclick="switchTab('tracking', this)">Track Shipment</button>
        <button class="tab-btn" onclick="switchTab('active', this)">Active Shipments</button>
      </div>

      <!-- ===== TAB: SHIPPING PARTNERS ===== -->
      <div id="partners-tab" class="tab-content active">
        <h2>Shipping Partners</h2>
        <p style="color: #666; margin-bottom: 20px;">Select your preferred shipping partner for upcoming shipments</p>

        <div class="partners-grid" id="partnersGrid">
          <!-- Populated by JavaScript -->
        </div>

        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h3>Selected Partner Details</h3>
          <div id="selectedPartnerDetails">
            <p style="color: #999;">Select a partner to view details</p>
          </div>
        </div>
      </div>

      <!-- ===== TAB: CREATE SHIPMENT ===== -->
      <div id="shipments-tab" class="tab-content">
        <h2> Create New Shipment</h2>
        <button class="btn btn-primary" onclick="openCreateShipmentModal()">
          <span class="material-symbols-rounded" style="font-size: 18px;">add</span>
          Create Shipment
        </button>

        <div id="createdShipmentsContainer" style="margin-top: 30px;">
          <div class="empty-state">
            <div class="empty-state-icon"></div>
            <p>No shipments created yet. Click "Create Shipment" to get started.</p>
          </div>
        </div>
      </div>

      <!-- ===== TAB: TRACK SHIPMENT ===== -->
      <div id="tracking-tab" class="tab-content">
        <h2>Track Shipment</h2>

        <div class="info-card">
          <strong>Tip:</strong> Search by Order ID or Tracking ID to view shipment status and timeline
        </div>

        <div class="shipments-section">
          <div class="section-header">
            <div class="section-title">Search Shipments</div>
          </div>

          <div class="search-bar" style="flex: 1;">
            <span class="search-icon material-symbols-rounded">search</span>
            <input type="text" id="trackingSearch" placeholder="Search by Order ID or Tracking ID..." onkeyup="searchTracking()">
          </div>

          <div id="trackingResultsContainer" style="margin-top: 20px;">
            <div class="empty-state">
              <div class="empty-state-icon"></div>
              <p>Enter an Order ID or Tracking ID to view shipment details</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== TAB: ACTIVE SHIPMENTS ===== -->
      <div id="active-tab" class="tab-content">
        <div class="shipments-section">
          <div class="section-header">
            <div class="section-title">Active Shipments</div>
            <div class="search-filter">
              <div class="search-bar">
                <span class="search-icon material-symbols-rounded">search</span>
                <input type="text" id="shipmentSearch" placeholder="Search by Order ID...">
              </div>
              <select class="filter-select" id="shipmentFilter">
                <option value="">All Status</option>
                <option value="Pending">Pending Pickup</option>
                <option value="In Transit">In Transit</option>
                <option value="Out for Delivery">Out for Delivery</option>
                <option value="Delivered">Delivered</option>
                <option value="Failed">Failed/Returned</option>
              </select>
            </div>
          </div>

          <table class="data-table" id="shipmentsTable">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Tracking ID</th>
                <th>Partner</th>
                <th>Status</th>
                <th>Pickup Date</th>
                <th>Expected Delivery</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="shipmentsTableBody">
            </tbody>
          </table>

          <div id="shipmentsPagination" class="pagination"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== MODALS ===== -->

  <!-- CREATE SHIPMENT MODAL -->
  <div class="modal" id="createShipmentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New Shipment</h2>
        <button class="modal-close" onclick="closeCreateShipmentModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Select Order *</label>
          <select id="orderSelect">
            <option value="">-- Select an Order --</option>
          </select>
        </div>

        <div class="form-group">
          <label>Select Shipping Partner *</label>
          <select id="partnerSelect">
            <option value="">-- Select a Partner --</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Package Weight (kg) *</label>
            <input type="number" id="packageWeight" placeholder="e.g., 2.5" min="0" step="0.1">
          </div>
          <div class="form-group">
            <label>Dimensions (cm) *</label>
            <input type="text" id="packageDimensions" placeholder="L√óW√óH (30√ó20√ó15)">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Pickup Date *</label>
            <input type="date" id="pickupDate">
          </div>
          <div class="form-group">
            <label>Expected Delivery Date *</label>
            <input type="date" id="deliveryDate">
          </div>
        </div>

        <div class="form-group">
          <label>Special Instructions (Optional)</label>
          <textarea id="shipmentNotes" placeholder="e.g., Handle with care, Fragile items..." style="min-height: 80px;"></textarea>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeCreateShipmentModal()">Cancel</button>
          <button class="btn btn-primary" onclick="createShipment()">Create Shipment</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TRACKING DETAILS MODAL -->
  <div class="modal" id="trackingDetailsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="trackingDetailsTitle">Shipment Details</h2>
        <button class="modal-close" onclick="closeTrackingDetailsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="background-color: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <p style="color: #999; font-size: 12px; margin-bottom: 5px;">Order ID</p>
              <p style="font-weight: 600; color: #333; font-size: 16px;" id="detailOrderId"></p>
            </div>
            <div>
              <p style="color: #999; font-size: 12px; margin-bottom: 5px;">Tracking ID</p>
              <p style="font-weight: 600; color: #333; font-size: 16px;" id="detailTrackingId"></p>
            </div>
            <div>
              <p style="color: #999; font-size: 12px; margin-bottom: 5px;">Shipping Partner</p>
              <p style="font-weight: 600; color: #333;" id="detailPartner"></p>
            </div>
            <div>
              <p style="color: #999; font-size: 12px; margin-bottom: 5px;">Current Status</p>
              <div id="detailStatus"></div>
            </div>
          </div>
        </div>

        <h3 style="margin-bottom: 15px;">Shipment Timeline</h3>
        <div class="timeline" id="trackingTimeline">
          <!-- Populated by JavaScript -->
        </div>

        <div style="margin-top: 20px; padding: 15px; background-color: #f9fafb; border-radius: 8px;">
          <h3 style="margin-bottom: 10px;">üìùInternal Notes</h3>
          <textarea id="internalNotes" placeholder="Add or edit notes..." style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; font-family: inherit;"></textarea>
          <button class="btn btn-primary" onclick="saveInternalNotes()" style="margin-top: 10px; width: 100%; justify-content: center;">Save Notes</button>
        </div>

        <div style="margin-top: 20px;">
          <button class="btn btn-secondary" onclick="closeTrackingDetailsModal()" style="width: 100%; justify-content: center;">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TRACKING ID UPLOAD MODAL -->
  <div class="modal" id="trackingIdModal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2>Upload Tracking ID</h2>
        <button class="modal-close" onclick="closeTrackingIdModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Shipment ID</label>
          <input type="text" id="shipmentIdInput" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
        </div>

        <div class="form-group">
          <label>Tracking ID *</label>
          <input type="text" id="trackingIdInput" placeholder="Enter tracking ID from shipping partner">
        </div>

        <div class="form-group">
          <label>Notes (Optional)</label>
          <textarea id="trackingNotes" placeholder="Add internal notes..." style="min-height: 80px;"></textarea>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeTrackingIdModal()">Cancel</button>
          <button class="btn btn-primary" onclick="uploadTrackingId()">Upload ID</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CONFIRMATION MODAL -->
  <div class="modal" id="confirmationModal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 id="confirmTitle">Confirm</h2>
        <button class="modal-close" onclick="closeConfirmationModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage" style="margin-bottom: 20px; color: #666; line-height: 1.6;"></p>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-secondary" onclick="closeConfirmationModal()" style="flex: 1; justify-content: center;">Cancel</button>
          <button class="btn btn-primary" onclick="confirmAction()" style="flex: 1; justify-content: center;">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== DATA =====
    const shippingPartners = [
      { id: 'tcs', name: 'TCS', logo: '', speed: '2-3 days', charge: '‚Çπ50', rating: '4.8/5' },
      { id: 'mp', name: 'M&P Express', logo: '', speed: '1-2 days', charge: '‚Çπ75', rating: '4.9/5' },
      { id: 'leopard', name: 'Leopard Courier', logo: '', speed: '2-4 days', charge: '‚Çπ40', rating: '4.6/5' },
      { id: 'own', name: 'Own Courier', logo: '', speed: '1-3 days', charge: '‚Çπ0', rating: 'Custom' }
    ];

    const sampleOrders = [
      { id: 'ORD-001', customer: 'John Doe', items: 3, amount: '‚Çπ2,500', date: '2025-12-05' },
      { id: 'ORD-002', customer: 'Jane Smith', items: 1, amount: '‚Çπ1,200', date: '2025-12-04' },
      { id: 'ORD-003', customer: 'Mike Johnson', items: 5, amount: '‚Çπ4,800', date: '2025-12-03' },
      { id: 'ORD-004', customer: 'Sarah Williams', items: 2, amount: '‚Çπ3,100', date: '2025-12-02' },
      { id: 'ORD-005', customer: 'Tom Brown', items: 4, amount: '‚Çπ5,600', date: '2025-12-01' }
    ];

    let selectedPartner = null;
    let createdShipments = [];
    let currentShipmentForTracking = null;
    let confirmCallback = null;
    let currentPage = 1;
    const itemsPerPage = 10;
    let filteredShipments = [];

    // ===== INITIALIZATION =====
    function initializeDeliveryPanel() {
      renderPartners();
      populateOrderSelects();
      populatePartnerSelects();
      setupSearchListeners();
    }

    // Call immediately (for fetch/eval loading)
    initializeDeliveryPanel();

    // Also call on DOMContentLoaded (for direct page load)
    document.addEventListener('DOMContentLoaded', function() {
      initializeDeliveryPanel();
    });

    // ===== SHIPPING PARTNERS =====
    function renderPartners() {
      const grid = document.getElementById('partnersGrid');
      grid.innerHTML = shippingPartners.map(partner => `
        <div class="partner-card ${selectedPartner?.id === partner.id ? 'selected' : ''}" onclick="selectPartner('${partner.id}')">
          <div class="partner-logo">${partner.logo}</div>
          <div class="partner-name">${partner.name}</div>
          <div class="partner-details">
            <p style="margin: 5px 0; font-size: 12px;">‚ö° ${partner.speed}</p>
            <p style="margin: 5px 0; font-size: 12px;">üí∞ ${partner.charge}</p>
            <p style="margin: 5px 0; font-size: 12px;">‚≠ê ${partner.rating}</p>
          </div>
        </div>
      `).join('');
    }

    function selectPartner(partnerId) {
      selectedPartner = shippingPartners.find(p => p.id === partnerId);
      renderPartners();
      displaySelectedPartnerDetails();
    }

    function displaySelectedPartnerDetails() {
      const detailsDiv = document.getElementById('selectedPartnerDetails');
      if (!selectedPartner) {
        detailsDiv.innerHTML = '<p style="color: #999;">Select a partner to view details</p>';
        return;
      }

      detailsDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
          <div>
            <p style="color: #999; font-size: 12px; margin-bottom: 5px;">Partner Name</p>
            <p style="font-weight: 600; color: #333;">${selectedPartner.name}</p>
          </div>
          <div>
            <p style="color: #999; font-size: 12px; margin-bottom: 5px;">Delivery Speed</p>
            <p style="font-weight: 600; color: #333;">${selectedPartner.speed}</p>
          </div>
          <div>
            <p style="color: #999; font-size: 12px; margin-bottom: 5px;">Charge</p>
            <p style="font-weight: 600; color: #232f3e; font-size: 16px;">${selectedPartner.charge}</p>
          </div>
          <div>
            <p style="color: #999; font-size: 12px; margin-bottom: 5px;">Rating</p>
            <p style="font-weight: 600; color: #232f3e;">‚≠ê ${selectedPartner.rating}</p>
          </div>
        </div>
        <div style="margin-top: 15px;">
          <button class="btn btn-primary" onclick="showConfirmation('Partner Selected', 'You have selected ${selectedPartner.name} as your default shipping partner.')">Set as Default</button>
        </div>
      `;
    }

    // ===== POPULATE DROPDOWNS =====
    function populateOrderSelects() {
      const select = document.getElementById('orderSelect');
      select.innerHTML = '<option value="">-- Select an Order --</option>' + 
        sampleOrders.map(o => `<option value="${o.id}">${o.id} - ${o.customer}</option>`).join('');
    }

    function populatePartnerSelects() {
      const select = document.getElementById('partnerSelect');
      select.innerHTML = '<option value="">-- Select a Partner --</option>' + 
        shippingPartners.map(p => `<option value="${p.id}">${p.name} - ${p.charge}</option>`).join('');
    }

    // ===== TAB SWITCHING =====
    function switchTab(tabName, btn) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
      btn.classList.add('active');

      if (tabName === 'active') {
        filteredShipments = [...createdShipments];
        renderShipmentsTable();
      }
    }

    // ===== CREATE SHIPMENT =====
    function openCreateShipmentModal() {
      document.getElementById('createShipmentModal').classList.add('active');
      document.getElementById('pickupDate').valueAsDate = new Date();
    }

    function closeCreateShipmentModal() {
      document.getElementById('createShipmentModal').classList.remove('active');
      document.getElementById('orderSelect').value = '';
      document.getElementById('partnerSelect').value = '';
      document.getElementById('packageWeight').value = '';
      document.getElementById('packageDimensions').value = '';
      document.getElementById('pickupDate').value = '';
      document.getElementById('deliveryDate').value = '';
      document.getElementById('shipmentNotes').value = '';
    }

    function createShipment() {
      const orderId = document.getElementById('orderSelect').value;
      const partnerId = document.getElementById('partnerSelect').value;
      const weight = document.getElementById('packageWeight').value;
      const dimensions = document.getElementById('packageDimensions').value;
      const pickupDate = document.getElementById('pickupDate').value;
      const deliveryDate = document.getElementById('deliveryDate').value;
      const notes = document.getElementById('shipmentNotes').value;

      if (!orderId || !partnerId || !weight || !dimensions || !pickupDate || !deliveryDate) {
        alert('Please fill in all required fields (marked with *)');
        return;
      }

      const shipmentId = 'SHP-' + Math.random().toString(36).substr(2, 9).toUpperCase();
      const partner = shippingPartners.find(p => p.id === partnerId);
      const order = sampleOrders.find(o => o.id === orderId);

      const shipment = {
        id: shipmentId,
        orderId: orderId,
        customer: order.customer,
        partner: partner.name,
        weight: weight,
        dimensions: dimensions,
        pickupDate: pickupDate,
        deliveryDate: deliveryDate,
        notes: notes,
        status: 'Pending',
        trackingId: null,
        internalNotes: '',
        createdAt: new Date().toLocaleDateString(),
        timeline: [
          { step: 'Pending', date: new Date().toLocaleDateString(), completed: true, current: true }
        ]
      };

      createdShipments.push(shipment);
      showConfirmation('‚úÖ Shipment Created Successfully', `Shipment ${shipmentId} has been created for order ${orderId}. Next step: Upload tracking ID once pickup is done.`, function() {
        closeCreateShipmentModal();
        renderCreatedShipments();
        switchTab('shipments', document.querySelectorAll('.tab-btn')[1]);
      });
    }

    function renderCreatedShipments() {
      const container = document.getElementById('createdShipmentsContainer');

      if (createdShipments.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No shipments created yet</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Shipment ID</th>
              <th>Order ID</th>
              <th>Partner</th>
              <th>Pickup Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${createdShipments.map(shipment => `
              <tr>
                <td><strong>${shipment.id}</strong></td>
                <td>${shipment.orderId}</td>
                <td>${shipment.partner}</td>
                <td>${shipment.pickupDate}</td>
                <td><span class="status-badge status-${shipment.status.toLowerCase().replace(/\s+/g, '-')}">${shipment.status}</span></td>
                <td>
                  ${!shipment.trackingId ? `<button class="btn-view" onclick="openTrackingIdModal('${shipment.id}')">Upload ID</button>` : `<button class="btn-view" onclick="viewTrackingDetails('${shipment.id}')">View Details</button>`}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ===== TRACKING ID UPLOAD =====
    function openTrackingIdModal(shipmentId) {
      const shipment = createdShipments.find(s => s.id === shipmentId);
      if (!shipment) return;

      currentShipmentForTracking = shipment;
      document.getElementById('shipmentIdInput').value = shipmentId;
      document.getElementById('trackingIdInput').value = shipment.trackingId || '';
      document.getElementById('trackingIdModal').classList.add('active');
    }

    function closeTrackingIdModal() {
      document.getElementById('trackingIdModal').classList.remove('active');
      document.getElementById('trackingIdInput').value = '';
      document.getElementById('trackingNotes').value = '';
    }

    function uploadTrackingId() {
      const trackingId = document.getElementById('trackingIdInput').value.trim();

      if (!trackingId) {
        alert('Please enter a tracking ID');
        return;
      }

      if (!/^[A-Z0-9]{8,}$/.test(trackingId)) {
        alert('Please enter a valid tracking ID (minimum 8 alphanumeric characters)');
        return;
      }

      if (currentShipmentForTracking) {
        currentShipmentForTracking.trackingId = trackingId;
        currentShipmentForTracking.status = 'In Transit';
        currentShipmentForTracking.internalNotes = document.getElementById('trackingNotes').value;
        currentShipmentForTracking.timeline.push({
          step: 'In Transit',
          date: new Date().toLocaleDateString(),
          completed: false,
          current: true
        });

        showConfirmation('‚úÖ Tracking ID Uploaded', `Tracking ID ${trackingId} has been uploaded successfully. Shipment status updated to "In Transit".`, function() {
          closeTrackingIdModal();
          renderCreatedShipments();
        });
      }
    }

    // ===== SEARCH & TRACKING =====
    function setupSearchListeners() {
      const searchInput = document.getElementById('shipmentSearch');
      const filterSelect = document.getElementById('shipmentFilter');

      if (searchInput) searchInput.addEventListener('input', function() {
        currentPage = 1;
        updateFilteredShipments();
      });
      if (filterSelect) filterSelect.addEventListener('change', function() {
        currentPage = 1;
        updateFilteredShipments();
      });
    }

    function updateFilteredShipments() {
      const searchValue = document.getElementById('shipmentSearch').value.toLowerCase();
      const filterValue = document.getElementById('shipmentFilter').value;

      filteredShipments = createdShipments.filter(shipment => {
        const matchesSearch = shipment.orderId.toLowerCase().includes(searchValue) || 
                            shipment.id.toLowerCase().includes(searchValue) ||
                            shipment.customer.toLowerCase().includes(searchValue);
        const matchesFilter = filterValue === '' || shipment.status === filterValue;
        return matchesSearch && matchesFilter;
      });

      renderShipmentsTable();
    }

    function renderShipmentsTable() {
      const tableBody = document.getElementById('shipmentsTableBody');
      if (!filteredShipments || filteredShipments.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No shipments found</td></tr>`;
        document.getElementById('shipmentsPagination').innerHTML = '';
        return;
      }

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = filteredShipments.slice(start, end);

      tableBody.innerHTML = pageItems.map(shipment => `
        <tr>
          <td><strong>${shipment.orderId}</strong></td>
          <td>${shipment.trackingId || '‚Äî'}</td>
          <td>${shipment.partner}</td>
          <td><span class="status-badge status-${shipment.status.toLowerCase().replace(/\s+/g, '-')}">${shipment.status}</span></td>
          <td>${shipment.pickupDate}</td>
          <td>${shipment.deliveryDate}</td>
          <td><button class="btn-view" onclick="viewTrackingDetails('${shipment.id}')">View</button></td>
        </tr>
      `).join('');

      renderPagination();
    }

    function renderPagination() {
      const paginationDiv = document.getElementById('shipmentsPagination');
      paginationDiv.innerHTML = '';
      const totalPages = Math.ceil(filteredShipments.length / itemsPerPage);

      if (totalPages <= 1) return;

      const prevBtn = document.createElement('button');
      prevBtn.textContent = 'Prev';
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderShipmentsTable();
        }
      });
      paginationDiv.appendChild(prevBtn);

      for (let i = 1; i <= totalPages; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = i === currentPage ? 'active' : '';
        pageBtn.addEventListener('click', () => {
          currentPage = i;
          renderShipmentsTable();
        });
        paginationDiv.appendChild(pageBtn);
      }

      const nextBtn = document.createElement('button');
      nextBtn.textContent = 'Next';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderShipmentsTable();
        }
      });
      paginationDiv.appendChild(nextBtn);
    }

    // ===== SEARCH TRACKING =====
    function searchTracking() {
      const searchTerm = document.getElementById('trackingSearch').value.toLowerCase();

      if (!searchTerm) {
        document.getElementById('trackingResultsContainer').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <p>Enter an Order ID or Tracking ID to view shipment details</p>
          </div>
        `;
        return;
      }

      const results = createdShipments.filter(s =>
        s.orderId.toLowerCase().includes(searchTerm) ||
        (s.trackingId && s.trackingId.toLowerCase().includes(searchTerm)) ||
        s.id.toLowerCase().includes(searchTerm)
      );

      if (results.length === 0) {
        document.getElementById('trackingResultsContainer').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <p>No shipments found matching your search</p>
          </div>
        `;
        return;
      }

      document.getElementById('trackingResultsContainer').innerHTML = results.map(shipment => `
        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <p style="color: #999; font-size: 12px; margin-bottom: 5px;">Order ID</p>
              <p style="font-weight: 600; color: #333;">${shipment.orderId}</p>
            </div>
            <div>
              <p style="color: #999; font-size: 12px; margin-bottom: 5px;">Tracking ID</p>
              <p style="font-weight: 600; color: #333;">${shipment.trackingId || 'Pending'}</p>
            </div>
            <div>
              <p style="color: #999; font-size: 12px; margin-bottom: 5px;">Partner</p>
              <p style="font-weight: 600; color: #333;">${shipment.partner}</p>
            </div>
            <div>
              <p style="color: #999; font-size: 12px; margin-bottom: 5px;">Status</p>
              <span class="status-badge status-${shipment.status.toLowerCase().replace(/\s+/g, '-')}">${shipment.status}</span>
            </div>
          </div>
          <button class="btn btn-primary" onclick="viewTrackingDetails('${shipment.id}')" style="width: 100%; justify-content: center;">View Full Details</button>
        </div>
      `).join('');
    }

    // ===== TRACKING DETAILS =====
    function viewTrackingDetails(shipmentId) {
      const shipment = createdShipments.find(s => s.id === shipmentId);
      if (!shipment) return;

      currentShipmentForTracking = shipment;

      document.getElementById('trackingDetailsTitle').textContent = `Shipment ${shipmentId}`;
      document.getElementById('detailOrderId').textContent = shipment.orderId;
      document.getElementById('detailTrackingId').textContent = shipment.trackingId || 'Not uploaded yet';
      document.getElementById('detailPartner').textContent = shipment.partner;
      document.getElementById('detailStatus').innerHTML = `<span class="status-badge status-${shipment.status.toLowerCase().replace(/\s+/g, '-')}">${shipment.status}</span>`;
      document.getElementById('internalNotes').value = shipment.internalNotes;

      renderTrackingTimeline();
      document.getElementById('trackingDetailsModal').classList.add('active');
    }

    function closeTrackingDetailsModal() {
      document.getElementById('trackingDetailsModal').classList.remove('active');
    }

    function renderTrackingTimeline() {
      const timeline = document.getElementById('trackingTimeline');
      const statuses = ['Pending', 'In Transit', 'Out for Delivery', 'Delivered'];
      const currentStatus = currentShipmentForTracking.status;
      const currentIndex = statuses.indexOf(currentStatus);

      timeline.innerHTML = statuses.map((status, index) => {
        const isCompleted = index < currentIndex;
        const isCurrent = status === currentStatus;
        const isDue = index > currentIndex;

        let dotClass = '';
        if (isCompleted) dotClass = 'completed';
        if (isCurrent) dotClass = 'active';

        const icon = {
          'Pending': 'üì¶',
          'In Transit': 'üöö',
          'Out for Delivery': 'üö™',
          'Delivered': '‚úÖ'
        }[status];

        return `
          <div class="timeline-item ${isCurrent ? 'active' : ''}">
            <div class="timeline-dot ${dotClass}"></div>
            <div class="timeline-content">
              <h4>${icon} ${status}</h4>
              <p>${isCompleted || isCurrent ? 'Completed' : 'Pending'}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function saveInternalNotes() {
      if (currentShipmentForTracking) {
        currentShipmentForTracking.internalNotes = document.getElementById('internalNotes').value;
        showConfirmation('‚úÖ Notes Saved', 'Internal notes have been saved successfully.');
      }
    }

    // ===== CONFIRMATION MODAL =====
    function showConfirmation(title, message, callback) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      confirmCallback = callback;
      document.getElementById('confirmationModal').classList.add('active');
    }

    function closeConfirmationModal() {
      document.getElementById('confirmationModal').classList.remove('active');
    }

    function confirmAction() {
      if (confirmCallback) confirmCallback();
      closeConfirmationModal();
    }

    // ===== EXPORT FUNCTIONS TO WINDOW =====
    // Make all functions accessible from onclick handlers when loaded via fetch/eval
    window.initializeDeliveryPanel = initializeDeliveryPanel;
    window.switchTab = switchTab;
    window.selectPartner = selectPartner;
    window.openCreateShipmentModal = openCreateShipmentModal;
    window.closeCreateShipmentModal = closeCreateShipmentModal;
    window.createShipment = createShipment;
    window.openTrackingIdModal = openTrackingIdModal;
    window.closeTrackingIdModal = closeTrackingIdModal;
    window.uploadTrackingId = uploadTrackingId;
    window.viewTrackingDetails = viewTrackingDetails;
    window.closeTrackingDetailsModal = closeTrackingDetailsModal;
    window.saveInternalNotes = saveInternalNotes;
    window.showConfirmation = showConfirmation;
    window.closeConfirmationModal = closeConfirmationModal;
    window.confirmAction = confirmAction;
  </script>
</body>
</html>
